app.factory("Aoi",["$q","IaCore",function(o,e){var r,t,n=10,c=!1,i={};return i.info=function(i,a){return r=o.defer(),c||(c=!0,t=e.http({url:"prod/info/"+i+"?filter=1&allstocker=1",method:"GET",timeout:n}),t.result.promise.then(function(o){c=!1,r.resolve(o)},function(o){c=!1,r.reject(o)})),r.promise},i.rerun=function(){c=!1},i.cancel=function(){t.cancel()},i}]),app.factory("Panel",function(){var o=10,e=19,r={};return r.valid=function(r){return!!r&&!(!$.isNumeric(r)||r.length!=o&&r.length!=e)},r}),app.controller("prodController",["$scope","$rootScope","$http","$timeout","$interval","IaCore","Aoi","Stocker","Panel","toasty","cfpLoadingBar",function(o,e,r,t,n,c,i,a,l,p,s){e.configprod={aoibarcode:c.storage({name:"aoibarcode"}),socketio:":8080"},e.aoiService={},e.stockerService={},e.userService={},e.printError=function(e,r,t){if(void 0!=r.error&&(r=r.error),r)switch(t){case"modal":c.modalError(o,r);break;default:p.error({title:e,msg:r,timeout:5e3})}};var d=io.connect(e.configprod.socketio);d.on("connect_error",function(){p.error({title:"Produccion",msg:"Error de conexion, servidor caido",timeout:5e3}),o.$apply()}),d.on("disconnect",function(){p.warning({title:"Produccion",msg:"Conexion finalizada"}),o.$apply()}),d.on("connect",function(){d.emit("produccion",e.configprod.aoibarcode),p.success({title:"Produccion",msg:"Descargando informacion"}),o.$apply()}),d.on("waitForGetProduction",function(){s.start(),o.$apply()}),a.nodeInit(d),d.on("getProduccionResponse",function(o){if(e.aoiService=o,void 0!=o.produccion.inspector?e.userService=o.produccion.inspector:e.userService=null,void 0==o.error){e.aoiService=o;try{e.renderPeriodChart()}catch(r){console.error(r)}o.produccion&&(e.stockerService.stocker=o.produccion.stocker,a.autoscroll(e.stockerService.stocker.paneles))}s.complete(),e.$digest()}),d.on("getProduccionResponseError",function(e){p.error({title:"Produccion",msg:"Error: "+e}),s.complete(),o.$apply()}),e.restartAoiData=function(o){void 0!=o&&(c.storage({name:"aoibarcode",value:o}),e.configprod.aoibarcode=o),e.aoiService={},e.stockerService={},e.userService={},d.emit("produccion",e.configprod.aoibarcode)};e.$on("scannerEvent:enter",function(o,r){e.UserScanned(r.value),a.add(r.value),a.panelAdd(r.value)});e.UserScanned=function(o){if((0===o.indexOf("LOGIN")||0===o.indexOf("DLOGIN"))&&o.length>5&&e.aoiService.produccion.barcode){var n=o.match(/\d+/);n&&(n=n[0]);var c=o.replace("DLOGIN","").replace("LOGIN",""),i=c.replace(n,"");p.info({title:"Inspector",msg:"Buscando datos de inspector",timeout:5e3});var a={name:i,userid:n,aoibarcode:e.aoiService.produccion.barcode};r({method:"POST",url:"prod/user/login",params:a}).then(function(o){o=o.data,o&&(o.error?e.printError("Stocker",o,"modal"):(p.success({title:"Inspector",msg:"Operacion completa",timeout:5e3}),e.userService=o,t(function(){},2e3)))},function(o){o&&(void 0!=o.error&&(o=o.error),p.error({title:"Atencion",msg:o,timeout:5e3}))})}}}]),app.controller("prodChartController",["$rootScope",function(o){o.renderPeriodChart=function(){if(void 0!=o.aoiService.produccion.period){var e=o.aoiService.produccion.period.map(function(o){return o.op}),r=e.filter(function(o,r){return e.indexOf(o)==r});$.each(r,function(e,r){var t=o.aoiService.produccion.period.filter(function(o,e){if(o.op==r)return o}),n=[];$.each(t,function(o,e){var r=new Date;n.push([Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),e.periodo.split(":")[0]),e.total])});var c=prodchart.series.map(function(o){return o.name}),i=c.indexOf(r);i<0?prodchart.addSeries({name:r,data:n}):prodchart.series[i].setData(n)})}}}]),app.controller("prodHeaderController",["$scope","$rootScope","IaCore",function(o,e,r){o.promptAoiSet=function(e){r.modal({scope:o,route:e,title:"AOI en produccion",type:"primary",controller:"promptAoiSetController"})},o.btnFormSelectOp=function(t){e.btnFormSelectOpProccessing||(e.btnFormSelectOpProccessing=!0,r.modal({scope:o,route:t,title:"Informacion de OP",type:"primary",controller:"btnFormSelectOpController"}))},o.promptStockerSet=function(e){r.modal({scope:o,route:e,title:"Nuevo stocker",type:"info",controller:"promptStockerSetController"})},o.promptStockerAddPanel=function(e){r.modal({scope:o,route:e,title:"Asignar panel a stocker",type:"warning",controller:"promptStockerAddPanelController"})},o.promptStockerReset=function(e){r.modal({scope:o,route:e,title:"Liberar stocker",type:"success",controller:"promptStockerRemoveController"})},o.promptStockerRemovePanel=function(e){r.modal({scope:o,route:e,title:"Remover panel de stocker",type:"danger",controller:"promptStockerRemovePanelController"})}}]),app.controller("promptStockerSetController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.add(e.prompt_value),e.dialog.close()})}]),app.controller("promptStockerRemoveController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.remove(e.prompt_value),e.dialog.close()})}]),app.controller("promptStockerAddPanelController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.panelAdd(e.prompt_value),e.dialog.close()})}]),app.controller("promptStockerRemovePanelController",["$scope","$rootScope","$timeout","Stocker",function(o,e,r,t){var n=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),n()}),c=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),c()});o.$on("prompt:enter",function(o,e){t.panelRemove(e.prompt_value),e.dialog.close()})}]),app.controller("promptAoiSetController",["$scope","$rootScope","$timeout","IaCore","Aoi",function(o,e,r,t,n){var c=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0}),c()}),i=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1}),i()});o.$on("prompt:enter",function(o,r){e.restartAoiData(r.prompt_value),r.dialog.close()})}]),app.controller("btnFormSelectOpController",["$scope","$rootScope","$timeout","IaCore","Aoi",function(o,e,r,t,n){var c=e.$on("modal:hide",function(o,t){r(function(){e.scannerListener=!0,e.btnFormSelectOpProccessing=!1}),c()}),i=e.$on("modal:show",function(o,t){r(function(){e.scannerListener=!1,e.btnFormSelectOpProccessing=!1}),i()})}]),app.factory("Stocker",["$q","$rootScope","IaCore","toasty","Panel",function(o,e,r,t,n){var c,i=8,a=function(o,e){return 0===o.indexOf(e)},l={};return l.autoscroll=function(o){var e=$("#stocker_box div.panel_trace"),r=$("#panel_"+o);r.offset()&&e.animate({scrollTop:r.offset().top-e.offset().top+e.scrollTop()})},l.nodeInit=function(o){c=o,c.on("stockerDeclaredResponse",function(o,r){t.clear(r),o&&(o.error?console.log("Error",o):(e.stockerService=o,l.autoscroll(e.stockerService.stocker.paneles))),e.$digest()}),c.on("stockerInfoResponse",function(o,r){t.clear(r),o&&(o.error?console.log("Error",o):(e.stockerService=o,l.autoscroll(e.stockerService.stocker.paneles))),e.$digest()}),c.on("stockerAddResponse",function(o,r){t.clear(r),o&&(o.error?e.printError("Stocker",o,"modal"):(t.success({title:"Stocker",msg:"Agregado correctamente",timeout:2e3}),e.stockerService=o)),e.$digest()}),c.on("stockerRemoveResponse",function(o,r){t.clear(r),o&&(o.error?e.printError("Stocker",o,"modal"):(t.success({title:"Stocker",msg:"Libreado correctamente",timeout:2e3}),e.stockerService={})),e.$digest()}),c.on("panelAddResponse",function(o,r){t.clear(r),o&&(o.error?e.printError("Panel",o,"modal"):(t.success({title:"Panel",msg:"Agregado correctamente",timeout:2e3}),e.stockerService.stocker=o)),e.$digest()}),c.on("panelRemoveResponse",function(o,r){t.clear(r),o&&(o.error?e.printError("Panel",o,"modal"):(t.success({title:"Panel",msg:"Removido correctamente",timeout:2e3}),e.stockerService.stocker=o)),e.$digest()})},l.valid=function(o){return!!o&&!(!a(o.toUpperCase(),"STK")||o.length!=i)},l.add=function(o){o=o.toUpperCase(),l.valid(o)&&t.wait({title:"Stocker",msg:"Agregando stocker a produccion",timeout:!1,onAdd:function(){c.emit("stockerAdd",o,this.id)}})},l.remove=function(o){o=o.toUpperCase(),l.valid(o)&&t.wait({title:"Stocker",msg:"Liberando de produccion",timeout:!1,onAdd:function(){c.emit("stockerRemove",o,this.id)}})},l.panelAdd=function(o){n.valid(o)&&t.wait({title:"Panel",msg:"Agregando panel al stocker",timeout:!1,onAdd:function(){c.emit("panelAdd",o,this.id)}})},l.panelRemove=function(o){n.valid(o)&&t.wait({title:"Panel",msg:"Removiendo panel de stocker",timeout:!1,onAdd:function(){c.emit("panelRemove",o,this.id)}})},l}]);